<!DOCTYPE html>
<html lang="en">

<head>
	<title>three.js ar - paint</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<link type="text/css" rel="stylesheet" href="main.css">
</head>

<body>
	<div id="camrea">
		<div class="camera">
			<video id="video">Video stream not available.</video>
		</div>
	</div>
	<script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-analytics.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-database.js"></script>


	<script>
		// Your web app's Firebase configuration
		// For Firebase JS SDK v7.20.0 and later, measurementId is optional
		var firebaseConfig = {
			apiKey: "AIzaSyCLGRmnw7ugm-R5w3_8p8qP5jHz4DogXXM",
			authDomain: "matas-8f467.firebaseapp.com",
			databaseURL: "https://matas-8f467-default-rtdb.firebaseio.com",
			projectId: "matas-8f467",
			storageBucket: "matas-8f467.appspot.com",
			messagingSenderId: "119258401801",
			appId: "1:119258401801:web:313d0d094555418e8cbcd8",
			measurementId: "G-RWFBKYRZ5H"
		};
		// Initialize Firebase
		firebase.initializeApp(firebaseConfig);
		firebase.analytics();
		var database = firebase.database();
	</script>
</head>

<body>
	<div id="ar-overly">
		<div id="controls">
			<button id="button-action" class="tool-button" type="button">screenshot</button>
			<button id="button-reset" class="tool-button" type="button">reset</button>
		</div>
		<div id="menus">
			<div id="trails_menu"></div>
			<div id="aircrafts_menu"></div>
		</div>
    <!-- <div class="USDZ-container">
        <a rel="ar" href="https://developer.apple.com/augmented-reality/quick-look/models/biplane/toy_biplane.usdz"><img class="image-model" src="https://developer.apple.com/augmented-reality/quick-look/models/biplane/biplane_2x.jpg" alt="" data-hires-status="replaced"></a>
    </div> -->
  </div>
	
  <script type="module">

		import * as THREE from './node_modules/three/build/three.module.js';
		import { TubePainter } from './node_modules/three/examples/jsm/misc/TubePainter.js';
		import { ARButton } from './ARButton.js';
		import { GLTFLoader } from './node_modules/three/examples/jsm/loaders/GLTFLoader.js';
		import * as HTML from './node_modules/html2canvas/dist/html2canvas.min.js';
		import { MTLLoader } from './node_modules/three/examples/jsm/loaders/MTLLoader.js';
		import { OBJLoader } from './node_modules/three/examples/jsm/loaders/OBJLoader.js';
		import { OrbitControls } from "./node_modules/three/examples/jsm/controls/OrbitControls.js";

		let container;
		let camera, controls, scene, renderer;
		let controller, painter, aircraft;
		let animationCycleStart = new Date();
		let trails = [];
		const cursor = new THREE.Vector3();

		let locations = [
			// top triangle
			[1/3, Math.sqrt(3)/2 + Math.sqrt(3)/6],
			[1, 0],
			[-1, 0],
			[0, Math.sqrt(3)],
			[1/3, Math.sqrt(3)/2 + Math.sqrt(3)/6],
			//bottom
			[1, Math.sqrt(3)/2 + Math.sqrt(3)/6 ],
			[0, -Math.sqrt(3)/2 + Math.sqrt(3)/6],
			[-1, Math.sqrt(3)/2 + Math.sqrt(3)/6],
			[1/3, Math.sqrt(3)/2 + Math.sqrt(3)/6],
			[1, 0],
		]
		locations = locations.map(([x,y]) => [-0.1, y/10-0.1, -x/10])
		locations = addMidpoints(locations, 20)

		const AIRCRAFTS_META_DATA = [
			{ id: "f15", type: "obj", scale: 0.007, text: "f-15" },
			{ id: "aero", type: "glb", scale: 0.005, text: "aero" },
			{ id: "kfir", type: "glb", scale: 0.005, text: "kfir" },
			{ id: "f16", type: "gltf", scale: 0.005, text: "f16" },
			{ id: "rafael", type: "gltf", scale: 0.005, text: "f-99" }
		]

		const TRAILS_META_DATA = [
			// { id: "eye", type: "glb", scale: 0.003, text: "eye" },
			// { id: "gold", type: "obj", scale: 0.0001, text: "gold" },
			// { id: "silver", type: "obj", scale: 0.0001, text: "silver" },
			// { id: "blue", type: "obj", scale: 0.0001, text: "blue" },
			// { id: "love", type: "glb", scale: 0.5, text: "love" },
			// { id: "star2", type: "obj", scale: 0.0001, text: "star2" },
			// { id: "star", type: "obj", scale: 0.0003, text: "star" },
			// { id: "ghost", type: "obj", scale: 0.003, text: "ghost" },
			// { id: "rainbow", type: "glb", scale: 0.1, text: "rainbow" },
			// { id: "cheeseburger", type: "glb", scale: 0.09, text: "cheeseburger" },
			// { id: "happyface", type: "glb", scale: 0.5, text: "happyface" },
			// { id: "eyes", type: "glb", scale: 0.02, text: "eyes" },
			// { id: "poo", type: "glb", scale: 0.5, text: "poo" },
			// { id: "cloud", type: "glb", scale: 0.12, text: "cloud" },
			// { id: "smoke", type: "glb", scale: 0.12, text: "smoke" },
			{ id: "star", type: "glb", scale: 0.08, text: "star" },
			{ id: "moustache", type: "glb", scale: 0.05, text: "moustache" },
			{ id: "crown", type: "glb", scale: 0.02, text: "crown" },
			{ id: "doughnut", type: "glb", scale: 0.1, text: "doughnut" },
		]

		init();
		animate();

		var pathRef = firebase.database().ref('path');
		pathRef.on('value', (snapshot) => {
			const data = snapshot.val();
			if(data)
				for (let location of data)
					if(locations.indexOf(location) === -1){
						// painter.lineTo({
						// 	x: location[0],
						// 	y: location[1],
						// 	z: location[2]
						// })
						// locations.push(location)
						// painter.update()
					}
			else {
				// locations = []
			}
		});

		function init() {

			AIRCRAFTS_META_DATA.forEach(aircraft => {
				const elem = document.createElement('button');
				elem.classList.add("aircraft-option");
				elem.type = "button";
				elem.id = aircraft.id;
				elem.innerText = aircraft.text;
				document.getElementById('aircrafts_menu').appendChild(elem);
				elem.addEventListener('click', () => {
					changeAircraft(aircraft);
				})
			})

			TRAILS_META_DATA.forEach(aircraft => {
				const elem = document.createElement('button');
				elem.classList.add("trails-option");
				elem.type = "button";
				elem.id = aircraft.id;
				elem.innerText = aircraft.text;
				document.getElementById('trails_menu').appendChild(elem);
				elem.addEventListener('click', () => {
					changeTrails(aircraft);
				})
			})


			scene = new THREE.Scene();
			camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
			camera.position.set(.1, .03, 0);

			renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.xr.enabled = true;
			// controls
			controls = new OrbitControls(camera, renderer.domElement);
			controls.listenToKeyEvents(window); // optional

			container = document.createElement('div');
			document.body.appendChild(container);
			container.appendChild(renderer.domElement);

			const arButton = ARButton.createButton(renderer, {
				optionalFeatures: ['dom-overlay', 'dom-overlay-for-handheld-ar'],
				domOverlay: { root: document.getElementById("ar-overly") },
				endSessionCallback: startup
			});

			document.body.appendChild(arButton);

			window.addEventListener('load', startup, false);
			var streaming = false;

			var video = null;

			function startup() {
				video = document.getElementById('video');
				navigator.mediaDevices.getUserMedia({ video: true, audio: false })
					.then(function (stream) {
						video.srcObject = stream;
						video.play();
						arButton.addEventListener('click', () => {
							stream.getTracks().forEach(function(track) {
								track.stop();
							});
						})
					})
					.catch(function (err) {
						console.log("An error occurred: " + err);
					});
				video.addEventListener('canplay', function (ev) {
					let width = window.screen.width;
					if (!streaming) {
						let height = video.videoHeight / (video.videoWidth / width);
						if (isNaN(height)) {
							height = width / (4 / 3);
						}
						
						video.setAttribute('width', width);
						video.setAttribute('height', height);
						streaming = true;
					}
				}, false);
			}
			// model

			document.getElementById("button-action").addEventListener("click", (e) => {
				takeScreenshot();
			})

			document.getElementById("button-reset").addEventListener("click", (e) => {
				resetScene();
			})

			changeAircraft(AIRCRAFTS_META_DATA[0]);
			loadLight();
			loadPainter();
			loadController();
			changeTrails(TRAILS_META_DATA[3]);

			window.addEventListener('resize', onWindowResize);
		}

		function createVidBackgrounds(){
			const canvas = document.createElement('canvas')
			let ctx = canvas.getContext('2d');
			let videos = document.querySelectorAll('video')
			let w, h
			for (let i = 0, len = videos.length; i < len; i++) {
				const v = videos[i]
				//debugger
				//if (!v.src) continue // no video here
				try {
					w = v.videoWidth
					h = v.videoHeight
					canvas.width = w
					canvas.height = h
					ctx.fillRect(0, 0, w, h)
					ctx.drawImage(v, 0, 0, w, h)
					document.body.style.backgroundImage = `url(${canvas.toDataURL()})` // here is the magic
					document.body.style.backgroundSize = 'cover' 
					ctx.clearRect(0, 0, w, h); // clean the canvas
				} catch (e) {
					continue
				}
			}
		}

		window.setInterval(createVidBackgrounds, 30)

		function takeScreenshot() {
			const canvas = document.getElementsByTagName('canvas')[0];
			createVidBackgrounds()
			html2canvas(document.querySelector("body")).then(canvas => {
				var base64image = canvas.toDataURL("image/png");
				var iframe = "<img src='" + base64image + "'>"
				var x = window.open();
				x.document.open();
				x.document.write(iframe);
				x.document.close();
			});
		}

		function resetScene() {
			locations = [];
			scene.remove(painter.mesh);
			loadPainter();
		}

		function loadController() {
			function onSelectStart() {
				this.userData.isSelecting = true;
				this.userData.skipFrames = 2;
				document.body.classList.add('is-selecting')
			}

			function onSelectEnd() {
				this.userData.isSelecting = false;
				firebase.database().ref('path').set(locations);
				document.body.classList.remove('is-selecting')
			}
			controller = renderer.xr.getController(0);
			controller.addEventListener('selectstart', onSelectStart);
			controller.addEventListener('selectend', onSelectEnd);
			controller.userData.skipFrames = 0;
			scene.add(controller);
		}

		function loadPainter() {
			painter = new TubePainter();
			painter.setSize(0.1);
			painter.mesh.material.transparent = true;
			painter.mesh.material.opacity = 0.3;
			painter.mesh.material.side = THREE.DoubleSide;
			painter.moveTo(locations[0] || [0, 0, 0])
			for (let location of locations)
				painter.lineTo({
					x: location[0],
					y: location[1],
					z: location[2]
				})
				painter.update()
			
			scene.add(painter.mesh);
		}

		function loadAircraft(selectedAircraft) {
			if (selectedAircraft.type == "gltf" || selectedAircraft.type == "glb") {
				loadAircraftGLTF(selectedAircraft);
			} else if (selectedAircraft.type == "obj") {
				loadAircraftOBJ(selectedAircraft);
			}
		}

		function loadAircraftGLTF(selectedAircraft) {
			new GLTFLoader()
				.load('./3d_models/aircrafts/gltf/' + selectedAircraft.id + '/object.' + selectedAircraft.type, function (gltf) {
					aircraft = gltf.scene;
					const scale = selectedAircraft.scale;
					aircraft.scale.set(scale, scale, scale);
					scene.add(aircraft);

				}, undefined, function (error) {
					console.error(error);
				});
		}

		function loadAircraftOBJ(selectedAircraft) {
			new MTLLoader()
				.setPath('./3d_models/aircrafts/obj/' + selectedAircraft.id + '/')
				.load('object.mtl', function (materials) {
					materials.preload();
					new OBJLoader()
						.setMaterials(materials)
						.setPath('./3d_models/aircrafts/obj/' + selectedAircraft.id + '/')
						.load('object.obj', function (object) {
							aircraft = object;
							const scale = selectedAircraft.scale;
							aircraft.scale.set(scale, scale, scale);
							scene.add(aircraft);
						}, undefined, function (error) {
							console.error(error);
						});
				});
		}

		function loadTrails(selectedTrails) {
			if (selectedTrails.type == "gltf" || selectedTrails.type == "glb") {
				loadTrailsGLTF(selectedTrails);
			} else if (selectedTrails.type == "obj") {
				loadTrailsOBJ(selectedTrails);
			}
		}

		function loadTrailsGLTF(selectedTrails) {
			for (let i = 0; i < 9; i++) {
				new GLTFLoader()
					.load('./3d_models/trails/gltf/' + selectedTrails.id + '/object.' + selectedTrails.type, function (gltf) {
						const trail = gltf.scene;
						// const num = ((1 - (i / 10)) % 1) / 10000
						const scale = selectedTrails.scale;
						trail.scale.set(scale, scale, scale);
						scene.add(trail);
						trails.push(trail);
					}, undefined, function (error) {
						console.error(error);
					});
			}
		}

		function loadTrailsOBJ(selectedTrails) {
			for (let i = 0; i < 9; i++) {
				new MTLLoader()
					.setPath('./3d_models/trails/obj/' + selectedTrails.id + '/')
					.load('object.mtl', function (materials) {
						materials.preload();
						new OBJLoader()
							.setMaterials(materials)
							.setPath('./3d_models/trails/obj/' + selectedTrails.id + '/')
							.load('object.obj', function (object) {
								const trail = object;
								// const num = ((1 - (i / 10)) % 1) / 10000
								const scale = selectedTrails.scale;
								trail.scale.set(scale, scale, scale);
								scene.add(trail);
								trails.push(trail);
							}, undefined, function (error) {
								console.error(error);
							});
					});
			}
		}

		function changeAircraft(selectedAircraft) {
			AIRCRAFTS_META_DATA.forEach(option => { document.getElementById(option.id).classList.remove("selected") });
			document.getElementById(selectedAircraft.id).classList.add("selected");
			scene.remove(aircraft);
			loadAircraft(selectedAircraft);
		}

		function changeTrails(selectedTrails) {
			TRAILS_META_DATA.forEach(option => { document.getElementById(option.id).classList.remove("selected") });
			document.getElementById(selectedTrails.id).classList.add("selected");
			scene.remove(trails);
			trails.forEach(trail => {scene.remove(trail)});
			trails = [];
			loadTrails(selectedTrails);
		}

		function loadLight() {
			const light = new THREE.HemisphereLight(0x999999, 0xbbbbff, 0.5);
			const AmbientLight = new THREE.AmbientLight( 0xFFFFFF ); // soft white light
			light.position.set(0, 1, 1);
			scene.add(light);
			scene.add( AmbientLight );
			const directionalLight = new THREE.DirectionalLight( 0x666666, 0.5 );
			scene.add( directionalLight );
		}

		function onWindowResize() {
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();
			renderer.setSize(window.innerWidth, window.innerHeight);
		}

		function handleController(controller) {
			const userData = controller.userData;
			cursor.set(0, 0, - 0.2).applyMatrix4(camera.matrixWorld);
			if (userData.isSelecting === true) {
				if (userData.skipFrames >= 0) {
					// TODO(mrdoob) Revisit this

					userData.skipFrames--;
					painter.moveTo(cursor);
				} else {
					painter.lineTo(cursor);
					locations.push([cursor.x, cursor.y, cursor.z])
					painter.update();
				}
			}
		}

		function animate() {
			renderer.setAnimationLoop(render);
		}

		function render() {
			handleController(controller);
			if (aircraft)
				placeAircraft()
			renderer.render(scene, camera);
		}

		function placeAircraft() {
			if (locations.length === 0) {
				aircraft?.position.set(0, 0, 0)
				aircraft?.rotation.set(0, 0, 0)
				trails.forEach(trail => trail.position.set(NaN, 0, 0))
				trails.forEach(trail => trail.rotation.set(0, 0, 0))
			} else if (locations.length === 1)
				aircraft?.position.set(...locations[0])
			else {
				const smoothLocations = smooth(addMidpoints(locations, 8));
				const currentTravelPercent = getCurrentTravelPercent();
				//document.getElementById("button-reset").innerHTML = (currentTravelPercent*100).toFixed(2);
				const currLoc = currentLocationByPercent(smoothLocations, currentTravelPercent),
					nextLoc = currentLocationByPercent(smoothLocations, currentTravelPercent + 0.01);

				aircraft?.position.set(...currLoc);
				aircraft.lookAt(...nextLoc);

				for (let i = 0; i < trails.length; i++) {
					const currTrailLoc = currentLocationByPercent(smoothLocations, currentTravelPercent + 0.98 - (i / 50));
					trails[i].position.set(...currTrailLoc);
					trails[i].rotation.x += (0.05 + i / 75);
					trails[i].rotation.z += (0.05 + i / 75);
					trails[i].rotation.z += (0.05 + i / 75);
				}
			}
		}

		function smooth(locations) {
			let result = [locations[0]];
			for (let i = 1; i < locations.length - 1; i++) {
				result.push(
					[
						(locations[i - 1][0] + locations[i][0] + locations[i + 1][0]) / 3,
						(locations[i - 1][1] + locations[i][1] + locations[i + 1][1]) / 3,
						(locations[i - 1][2] + locations[i][2] + locations[i + 1][2]) / 3
					]
				);
			}
			result.push(locations[locations.length - 1])
			return result;
		}

		function addMidpoints(locations, iterations = 1) {
			let result = [locations[0]];
			for (let i = 1; i < locations.length; i++) {
				result.push(
					[
						(locations[i - 1][0] + locations[i][0]) / 2,
						(locations[i - 1][1] + locations[i][1]) / 2,
						(locations[i - 1][2] + locations[i][2]) / 2
					],
					locations[i]
				);
			}
			if (iterations > 1)
				return addMidpoints(locations, iterations - 1)
			return result;
		}

		function currentLocationByPercent(locations, percent) {
			if(percent >= 1) return currentLocationByPercent(locations, percent % 1)
			if(percent < 0) return currentLocationByPercent(locations, (percent + 100) % 1)

			const idx = Math.floor(locations.length * percent),
				  r = (locations.length * percent) % 1;

			if(idx === locations.length-1)
				return locations[idx];

			return locations[idx].map((val, axis) => val + (locations[idx+1][axis]-val) * r)
		}

		function getCurrentTravelPercent() {
			const totalMillis = travelLength(locations) * 10000;
			if (Date.now() - animationCycleStart > totalMillis)
				animationCycleStart = Date.now();

			return (Date.now() - animationCycleStart) / totalMillis;
		}

		function travelLength(locations) {
			let result = 0;
			for (let i = 0; i < locations.length; i++) {
				result += oclidianDistance(locations[i], locations[(i + 1) % locations.length])
			}
			return result;
		}

		function oclidianDistance([x0, y0, z0], [x1, y1, z1]) {
			return Math.sqrt(
				Math.pow(x1 - x0, 2) +
				Math.pow(y1 - y0, 2) +
				Math.pow(z1 - z0, 2)
			)
		}

		window.onerror = function myErrorHandler(errorMsg, url, lineNumber) {
			alert("Error occured: " + JSON.stringify({errorMsg, url, lineNumber}));//or any message
			alert("toError:", window.toError)
			return false;
		}

	</script>

	<!-- <script>
		function isIOS() {
			return [
				'iPad Simulator',
				'iPhone Simulator',
				'iPod Simulator',
				'iPad',
				'iPhone',
				'iPod'
			].includes(navigator.platform)
			|| (navigator.userAgent.includes("Mac") && "ontouchend" in document)
		}

		if (!isIOS()) {
			document.getElementsByClassName('USDZ-container')[0].innerHTML = "USDZ not supported 😢"
		}
	</script> -->
</body>

</html>