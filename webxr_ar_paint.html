<!DOCTYPE html>
<html lang="en">

<head>
	<title>three.js ar - paint</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<link type="text/css" rel="stylesheet" href="main.css">
</head>

<body>
	<div id="camrea">
		<div class="camera">
			<video id="video">Video stream not available.</video>
		</div>
	</div>
	<script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-analytics.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-database.js"></script>


	<script>
		// Your web app's Firebase configuration
		// For Firebase JS SDK v7.20.0 and later, measurementId is optional
		var firebaseConfig = {
			apiKey: "AIzaSyCLGRmnw7ugm-R5w3_8p8qP5jHz4DogXXM",
			authDomain: "matas-8f467.firebaseapp.com",
			databaseURL: "https://matas-8f467-default-rtdb.firebaseio.com",
			projectId: "matas-8f467",
			storageBucket: "matas-8f467.appspot.com",
			messagingSenderId: "119258401801",
			appId: "1:119258401801:web:313d0d094555418e8cbcd8",
			measurementId: "G-RWFBKYRZ5H"
		};
		// Initialize Firebase
		firebase.initializeApp(firebaseConfig);
		firebase.analytics();
		var database = firebase.database();
	</script>
</head>

<body>
	<div id="ar-overly">
		<div id="controls">
			<button id="button-action" class="tool-button" type="button">screenshot</button>
			<button id="button-reset" class="tool-button" type="button">reset</button>
			<button id="button-aircraft" class="tool-button" type="button">aircraft</button>
		</div>
		<div id="menus">
			<div id="aircrafts_menu" class="closed"></div>
			<div id="trails_menu"></div>
		</div>
	</div>
	<script type="module">

		import * as THREE from './node_modules/three/build/three.module.js';
		import { TubePainter } from './node_modules/three/examples/jsm/misc/TubePainter.js';
		import { ARButton } from './node_modules/three/examples/jsm/webxr/ARButton.js';
		import { GLTFLoader } from './node_modules/three/examples/jsm/loaders/GLTFLoader.js';
		import * as HTML from './node_modules/html2canvas/dist/html2canvas.min.js';
		import { MTLLoader } from './node_modules/three/examples/jsm/loaders/MTLLoader.js';
		import { OBJLoader } from './node_modules/three/examples/jsm/loaders/OBJLoader.js';
		import { OrbitControls } from "./node_modules/three/examples/jsm/controls/OrbitControls.js";

		let container;
		let camera, controls, scene, renderer;
		let controller, painter, aircraft;
		let animationCycleStart = new Date();
		let trails = [];
		const cursor = new THREE.Vector3();
		/*
		// חג שמח:
		let locations = [
			[ 0.04866672959178686, 0.006803244724869727, -0.3409893661737442 ], [ 0.05293716071173549, 0.004840782657265662, -0.3406402438879013 ], [ 0.05823632944375277, 0.0033699754625558832, -0.3396037757396698 ], [ 0.06831582728773355, -0.0017065178602933898, -0.3365271627902985 ], [ 0.07765093110501767, -0.03345448775216937, -0.32704021334648137 ], [ 0.07681650407612324, -0.0343235781416297, -0.32684509456157684 ], [ 0.07744426373392344, -0.034736101515591145, -0.32661566436290745 ], [ 0.07760097570717335, -0.03483564592897892, -0.32651237547397616 ], [ 0.07738442160189152, -0.034826733544468885, -0.32659767270088197 ], [ 0.07706646639853716, -0.035354303382337096, -0.3266508758068085 ], [ 0.07741715591400862, -0.035568867903202774, -0.32651970684528353 ], [ 0.07815040368586779, -0.03565902709960938, -0.3268314987421036 ], [ 0.07847065329551697, -0.03546144980937243, -0.3266160488128662 ], [ 0.07861628476530313, -0.03555803028866649, -0.32654292285442355 ], [ 0.07897899523377419, -0.03579038744792343, -0.3266067266464233 ], [ 0.07949448972940446, -0.03572791498154402, -0.3264116227626801 ], [ 0.07959947772324086, -0.0362259590998292, -0.32651965916156767 ], [ 0.0795515138655901, -0.03661865452304483, -0.3265569180250168 ], [ 0.04472490958869457, -0.0070773191750049605, -0.3400315046310425 ], [ 0.04372472972609103, -0.014021208696067336, -0.33939123153686523 ], [ 0.04193817875348032, -0.02083678301423788, -0.3380297690629959 ], [ 0.04039873154833913, -0.02670279070734978, -0.336832070350647 ], [ 0.03813860411755741, -0.037828930467367176, -0.33449379205703733 ], [ 0.03753241545055062, -0.042250037565827375, -0.3335663050413132 ], [ 0.037267813971266155, -0.04309985050931573, -0.33331258594989777 ], [ 0.03713777668308467, -0.0434607326053083, -0.33332752883434297 ], [ 0.03703533923253417, -0.0435059279203415, -0.333409920334816 ], [ 0.03702111856546253, -0.04364287983626128, -0.3333606570959091 ], [ 0.03729267450980842, -0.04341749441809953, -0.33306774497032166 ], [ 0.03738582842051983, -0.04352946490980685, -0.333061671257019 ], [ 0.03735562148503959, -0.043559733964502814, -0.33312924206256866 ], [ 0.03726414579432458, -0.04382544332183898, -0.33294244706630705 ], [ 0.03703501122072339, -0.04418301517143846, -0.33303881585597994 ], [ 0.03723644013516605, -0.04430510741658509, -0.3330113768577576 ], [ 0.037446432909928266, -0.044510709866881375, -0.3330177217721939 ], [ 0.03757871144916863, -0.04436302329413593, -0.33297683000564576 ], [ 0.03773372247815132, -0.04443297889083624, -0.3329457610845566 ], [ -0.008426009118556975, 0.006365140527486801, -0.3488454282283783 ], [ -0.007601993344724178, -3.211170434951789E-4, -0.3479422628879547 ], [ -0.007476310431957244, -0.006538060307502747, -0.34708245992660525 ], [ -0.008659947291016578, -0.014833552390336992, -0.34571447372436526 ], [ -0.008800043351948261, -0.01679620631039143, -0.3452102363109589 ], [ -0.008056649938225746, -0.016190214827656747, -0.34516841173171997 ], [ -0.009126633591949939, -0.016676397807896138, -0.3456241816282273 ], [ -0.011815374158322811, -0.016161552816629413, -0.3464686214923859 ], [ -0.019587092194706203, -0.014585232175886632, -0.34753878116607667 ], [ -0.02511797919869423, -0.013598147593438626, -0.34727047979831693 ], [ -0.03034139983355999, -0.012624537013471129, -0.34709554314613345 ], [ -0.03442574664950371, -0.012964740209281445, -0.3470003306865692 ], [ -0.03786181733012199, -0.015162396430969241, -0.34631431400775914 ], [ -0.04094308279454709, -0.018871280737221243, -0.34558179676532746 ], [ -0.04375538155436516, -0.023456296324729918, -0.3447073698043823 ], [ -0.045460698381066325, -0.02685889508575201, -0.34415834546089175 ], [ -0.046619955077767374, -0.03117286562919617, -0.3433376640081406 ], [ -0.04735645018517971, -0.035189708136022096, -0.3422785073518753 ], [ -0.04698172248899937, -0.04008087441325188, -0.3412453353404999 ], [ -0.04570294432342052, -0.04497428145259619, -0.34002685546875 ], [ -0.043208108842372896, -0.05016471160342917, -0.3384892553091049 ], [ -0.0396270040422678, -0.05437163925962523, -0.33697170913219454 ], [ -0.03717213049530983, -0.056504598516039554, -0.33609017431735994 ], [ -0.03405045308172703, -0.05763419417198748, -0.33564426302909856 ], [ -0.029442939907312393, -0.058562345313839616, -0.3353989064693451 ], [ -0.024477014690637587, -0.05946831712499261, -0.3354034274816513 ], [ -0.019614783581346273, -0.0594841820653528, -0.3349820613861084 ], [ -0.014970193896442652, -0.05817315999884159, -0.3350793272256851 ], [ -0.012117256596684455, -0.0574420198565349, -0.3352481544017792 ], [ -0.011572646908462048, -0.05821966538205743, -0.3351474583148957 ], [ -0.010728627070784568, -0.05785700224805623, -0.3350690394639969 ], [ 0.0713718120008707, -0.08803810179233551, -0.3097719967365265 ], [ 0.06658715270459653, -0.08758557941764594, -0.31174704134464265 ], [ 0.058197784982621674, -0.08640852756798267, -0.31459231674671173 ], [ 0.049781961413100366, -0.08637263476848603, -0.3164831727743149 ], [ 0.044141909666359426, -0.0894371520727873, -0.31584654450416566 ], [ 0.038874988502357155, -0.096260654181242, -0.31393930613994603 ], [ 0.03618335495702923, -0.10304039344191551, -0.31134757995605467 ], [ 0.03481102182995528, -0.10943606942892076, -0.3086114525794983 ], [ 0.03663764123339206, -0.11517966054379941, -0.3052696764469147 ], [ 0.04316153342369944, -0.11963465698063375, -0.30193716287612915 ], [ 0.051591953542083506, -0.12072885632514954, -0.2992686152458191 ], [ 0.058750930801033975, -0.11861029341816903, -0.29864547252655027 ], [ 0.06855421736836434, -0.11455885991454125, -0.29850858449935913 ], [ 0.07272910606116056, -0.11226472668349743, -0.29929753541946413 ], [ 0.07542437929660083, -0.10621925257146358, -0.3018274962902069 ], [ 0.07649085968732834, -0.09922669883817435, -0.3046559602022171 ], [ 0.07621204648166895, -0.09553416259586811, -0.30607529878616335 ], [ 0.07415364366024733, -0.09072932619601488, -0.3086365580558777 ], [ 0.07092518731951714, -0.0893703680485487, -0.3103122770786285 ], [ 0.058336046151816846, -0.08963659312576056, -0.31396753191947935 ], [ 0.05295135816559196, -0.09044998325407505, -0.3143026292324066 ], [ 0.04501490207621828, -0.09395057614892721, -0.3144517451524734 ], [ 0.03859181592706591, -0.09837822783738376, -0.3133172392845154 ], [ 0.033614962175488476, -0.10546266958117485, -0.31090401113033295 ], [ 0.029947102162986995, -0.11400838382542133, -0.30733563303947453 ], [ 0.02938362052664161, -0.12486816681921482, -0.3015682488679886 ], [ 0.042638527855160646, -0.1445420052856207, -0.28793140947818757 ], [ 0.051536988094449045, -0.1467251516878605, -0.2845829397439957 ], [ 0.0607412469573319, -0.14741512164473536, -0.2817750543355942 ], [ 0.06809462141245604, -0.1481850527226925, -0.2796474039554596 ], [ 0.07378794476389886, -0.14854202121496202, -0.2789877951145172 ], [ 0.07523468900471926, -0.14765516817569735, -0.27917922735214235 ], [ 0.0755818173289299, -0.1466691128909588, -0.2796777844429016 ], [ 0.014265449158847334, -0.1102256178855896, -0.3118694603443146 ], [ 0.012600595504045489, -0.12367971129715444, -0.30587188005447385 ], [ 0.00979087594896555, -0.13819189220666886, -0.29808944761753087 ], [ 0.00720727574080229, -0.1417958963662386, -0.29607207477092745 ], [ 0.005849931389093399, -0.14300075843930243, -0.29543147683143617 ], [ 0.004281392507255077, -0.14238729290664198, -0.29612160027027135 ], [ -0.00100222248584032, -0.13456705063581467, -0.30131334960460665 ], [ -0.006703197211027145, -0.12485808953642846, -0.30733112394809725 ], [ -0.01057140901684761, -0.11540423966944219, -0.31259483397006993 ], [ -0.01395833194255829, -0.10684014521539212, -0.3167622864246369 ], [ -0.014597445726394653, -0.10397172644734383, -0.3176269233226776 ], [ -0.014833121746778487, -0.1036949135363102, -0.3177901417016983 ], [ -0.01568930521607399, -0.10417869463562966, -0.3179525971412659 ], [ -0.016001338511705397, -0.10432394444942475, -0.31792517304420476 ], [ -0.015290118381381035, -0.10438816659152508, -0.3175912261009216 ], [ -0.015675340965390205, -0.10597795844078065, -0.31723971962928776 ], [ -0.016527183726429938, -0.10833466611802578, -0.3160910278558731 ], [ -0.017795753106474875, -0.1144430559128523, -0.31294930875301363 ], [ -0.019515963830053808, -0.12057399973273278, -0.31019620299339296 ], [ -0.02381915654987097, -0.139186879247427, -0.30063695311546323 ], [ -0.024075898341834545, -0.1416397374123335, -0.29953593313694005 ], [ -0.023927709460258482, -0.14129376150667666, -0.2997034221887589 ], [ -0.024214959517121316, -0.14192026257514956, -0.29959388077259064 ], [ -0.024127187207341194, -0.14214161336421965, -0.2995853364467621 ], [ -0.0239351574331522, -0.14184925928711892, -0.2996800780296326 ], [ -0.023895869962871075, -0.1418971434235573, -0.2997314691543579 ], [ -0.0626549892127514, -0.09155347291380167, -0.3230379670858383 ], [ -0.0583758719265461, -0.09287243857979775, -0.323007395863533 ], [ -0.05811773240566254, -0.09340507294982672, -0.322871008515358 ], [ -0.057476644217967984, -0.0931656789034605, -0.32273513078689575 ], [ -0.05791518390178681, -0.09308295156806708, -0.32276414632797246 ], [ -0.058394552767276765, -0.09341019727289677, -0.32286966443061826 ], [ -0.059262615442276, -0.0946601789444685, -0.3227435857057571 ], [ -0.030674583092331887, -0.13089803010225298, -0.3057424455881119 ], [ -0.031348568946123125, -0.13477287739515303, -0.30346774160861967 ], [ -0.03205527812242508, -0.14030702225863934, -0.30009104609489445 ], [ -0.03278911225497723, -0.14452914744615555, -0.2977238655090332 ], [ -0.033770253881812096, -0.1474837362766266, -0.2964084804058075 ], [ -0.034706678614020346, -0.14897550642490387, -0.29556978642940523 ], [ -0.03438102342188358, -0.14883822202682495, -0.29560618400573735 ], [ -0.03483149595558643, -0.14903808757662773, -0.2955839544534683 ], [ -0.0638992354273796, -0.11074096858501435, -0.3142498791217804 ], [ -0.06575494632124901, -0.13324760012328624, -0.3051166832447052 ],
			[ -0.06574125811457635, -0.13811069279909133, -0.30209772586822514 ], [ -0.0649755522608757, -0.14360087290406226, -0.2988394409418106 ], [ -0.06453352123498916, -0.1505926474928856, -0.29474276304244995 ], [ -0.06437852457165719, -0.1529379576444626, -0.29332548975944517 ], [ -0.06408085450530052, -0.15533972010016442, -0.2920353353023529 ], [ -0.06424178034067154, -0.15719607993960383, -0.29112957715988164 ], [ -0.06428892388939858, -0.15739059671759606, -0.29081798195838926 ], [ -0.0637994647026062, -0.1569841928780079, -0.29095653593540194 ]
		];
		locations.forEach(point => {
			[point[0], point[1], point[2]] = [-point[0], point[1], -point[2]];
			point[0] -=0.5
			point[2]+=0.3
		});*/

		let locations = [
			// top triangle
			[1/3, Math.sqrt(3)/2 + Math.sqrt(3)/6],
			[1, 0],
			[-1, 0],
			[0, Math.sqrt(3)],
			[1/3, Math.sqrt(3)/2 + Math.sqrt(3)/6],
			//bottom
			[1, Math.sqrt(3)/2 + Math.sqrt(3)/6 ],
			[0, -Math.sqrt(3)/2 + Math.sqrt(3)/6],
			[-1, Math.sqrt(3)/2 + Math.sqrt(3)/6],
			[1/3, Math.sqrt(3)/2 + Math.sqrt(3)/6],
			[1, 0],
		]
		locations = locations.map(([x,y]) => [-0.1, y/10-0.1, -x/10])
		locations = addMidpoints(locations, 20)

		let selectedAircraft = "aero";
		let isAircraftsMenuOpen = false;

		const AIRCRAFTS_META_DATA = [
			{ id: "aero", type: "gltf", scale: 0.003, text: "f->?" },
			{ id: "F35", type: "gltf", scale: 0.02, text: "f-5" },
			{ id: "rafael", type: "gltf", scale: 0.003, text: "f-99" },
			{ id: "f15", type: "obj", scale: 0.006, text: "f-15" }
		]

		const TRAILS_META_DATA = [
			{ id: "eye", type: "gltf", scale: 0.003, text: "eye" },
			{ id: "gold", type: "obj", scale: 0.003, text: "gold" },
			{ id: "silver", type: "obj", scale: 0.003, text: "silver" },
			{ id: "blue", type: "obj", scale: 0.003, text: "blue" }
		]

		init();
		animate();

		var pathRef = firebase.database().ref('path');
		pathRef.on('value', (snapshot) => {
			const data = snapshot.val();
			if(data)
				for (let location of data)
					if(locations.indexOf(location) === -1){
						// painter.lineTo({
						// 	x: location[0],
						// 	y: location[1],
						// 	z: location[2]
						// })
						// locations.push(location)
						// painter.update()
					}
			else {
				// locations = []
			}
		});

		function init() {

			AIRCRAFTS_META_DATA.forEach(aircraft => {
				const elem = document.createElement('button');
				elem.classList.add("aircraft-option");
				elem.type = "button";
				elem.id = aircraft.id;
				elem.innerText = aircraft.text;
				document.getElementById('aircrafts_menu').appendChild(elem);
				elem.addEventListener('click', () => {
					changeAircraft(aircraft);
				})
			})

			TRAILS_META_DATA.forEach(aircraft => {
				const elem = document.createElement('button');
				elem.classList.add("trails-option");
				elem.type = "button";
				elem.id = aircraft.id;
				elem.innerText = aircraft.text;
				document.getElementById('trails_menu').appendChild(elem);
				elem.addEventListener('click', () => {
					changeTrails(aircraft);
				})
			})


			scene = new THREE.Scene();
			camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
			camera.position.set(.1, .03, 0);

			renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.xr.enabled = true;

			// controls
			controls = new OrbitControls(camera, renderer.domElement);
			controls.listenToKeyEvents(window); // optional

			container = document.createElement('div');
			document.body.appendChild(container);
			container.appendChild(renderer.domElement);

			document.body.appendChild(ARButton.createButton(renderer, {
				optionalFeatures: ['dom-overlay', 'dom-overlay-for-handheld-ar'],
				domOverlay: { root: document.getElementById("ar-overly") }
			}));

			window.addEventListener('load', startup, false);
			var width = 320;
			var height = 0;
			var streaming = false;

			var video = null;

			function startup() {
				video = document.getElementById('video');
				/*navigator.mediaDevices.getUserMedia({ video: true, audio: false })
					.then(function (stream) {
						video.srcObject = stream;
						video.play();
					})
					.catch(function (err) {
						console.log("An error occurred: " + err);
					});

				video.addEventListener('canplay', function (ev) {
					if (!streaming) {
						height = video.videoHeight / (video.videoWidth / width);
						if (isNaN(height)) {
							height = width / (4 / 3);
						}
						
						video.setAttribute('width', width);
						video.setAttribute('height', height);
						streaming = true;
					}
				},false);
				*/
			}



			// Set up our event listener to run the startup process
			// once loading is complete.



			// document.getElementById("screenshot-button").addEventListener("click", (e) => {
			// 	// const canvas = document.getElementsByTagName('canvas')[0];
			// 	// var base64image = canvas.toDataURL("/image.png");
			// 	// window.location.href = base64image;
			// });

			// model

			document.getElementById("button-action").addEventListener("click", (e) => {
				takeScreenshot();
			})

			document.getElementById("button-reset").addEventListener("click", (e) => {
				resetScene();
			})

			document.getElementById("button-aircraft").addEventListener("click", (e) => {
				if(isAircraftsMenuOpen) {
					document.getElementById('aircrafts_menu').classList.add("closed");
					isAircraftsMenuOpen = !isAircraftsMenuOpen;
				} else {
					document.getElementById('aircrafts_menu').classList.remove("closed");
					isAircraftsMenuOpen = !isAircraftsMenuOpen;
				}
			})

			changeAircraft(AIRCRAFTS_META_DATA[3]);
			loadLight();
			loadPainter();
			loadController();
			changeTrails(TRAILS_META_DATA[3]);

			window.addEventListener('resize', onWindowResize);
		}

		function createVidBackgrounds(){
			const canvas = document.createElement('canvas')
			let ctx = canvas.getContext('2d');
			let videos = document.querySelectorAll('video')
			let w, h
			for (let i = 0, len = videos.length; i < len; i++) {
				const v = videos[i]
				//debugger
				//if (!v.src) continue // no video here
				try {
					w = v.videoWidth
					h = v.videoHeight
					canvas.width = w
					canvas.height = h
					ctx.fillRect(0, 0, w, h)
					ctx.drawImage(v, 0, 0, w, h)
					v.style.backgroundImage = `url(${canvas.toDataURL()})` // here is the magic
					v.style.backgroundSize = 'cover' 
					ctx.clearRect(0, 0, w, h); // clean the canvas
				} catch (e) {
					continue
				}
			}
		}

		function takeScreenshot() {
			const canvas = document.getElementsByTagName('canvas')[0];
			createVidBackgrounds()
			html2canvas(document.querySelector("body")).then(canvas => {
				var base64image = canvas.toDataURL("image/png");
				var iframe = "<img src='" + base64image + "'>"
				var x = window.open();
				x.document.open();
				x.document.write(iframe);
				x.document.close();
			});
		}

		function resetScene() {
			locations = [];
			scene.remove(painter.mesh);
			loadPainter();
		}

		function loadController() {
			function onSelectStart() {
				this.userData.isSelecting = true;
				this.userData.skipFrames = 2;
			}

			function onSelectEnd() {
				this.userData.isSelecting = false;
				firebase.database().ref('path').set(locations);
			}
			controller = renderer.xr.getController(0);
			controller.addEventListener('selectstart', onSelectStart);
			controller.addEventListener('selectend', onSelectEnd);
			controller.userData.skipFrames = 0;
			scene.add(controller);
		}

		function loadPainter() {
			painter = new TubePainter();
			painter.setSize(0.1);
			painter.mesh.material.transparent = true;
			painter.mesh.material.opacity = 0.3;
			painter.mesh.material.side = THREE.DoubleSide;
			painter.moveTo(locations[0])
			for (let location of locations)
				painter.lineTo({
					x: location[0],
					y: location[1],
					z: location[2]
				})
				painter.update()
			
			scene.add(painter.mesh);
		}

		function loadAircraft(selectedAircraft) {
			if (selectedAircraft.type == "gltf") {
				loadAircraftGLTF(selectedAircraft);
			} else if (selectedAircraft.type == "obj") {
				loadAircraftOBJ(selectedAircraft);
			}
		}

		function loadAircraftGLTF(selectedAircraft) {
			new GLTFLoader()
				.load('./3d_models/aircrafts/gltf/' + selectedAircraft.id + '/object.gltf', function (gltf) {
					aircraft = gltf.scene;
					const scale = selectedAircraft.scale;
					aircraft.scale.set(scale, scale, scale);
					scene.add(aircraft);

				}, undefined, function (error) {
					console.error(error);
				});
		}

		function loadAircraftOBJ(selectedAircraft) {
			new MTLLoader()
				.setPath('./3d_models/aircrafts/obj/' + selectedAircraft.id + '/')
				.load('material.mtl', function (materials) {
					materials.preload();
					new OBJLoader()
						.setMaterials(materials)
						.setPath('./3d_models/aircrafts/obj/' + selectedAircraft.id + '/')
						.load('object.obj', function (object) {
							aircraft = object;
							const scale = selectedAircraft.scale;
							aircraft.scale.set(scale, scale, scale);
							scene.add(aircraft);
						}, undefined, function (error) {
							console.error(error);
						});
				});
		}

		function loadTrails(selectedTrails) {
			if (selectedTrails.type == "gltf") {
				loadTrailsGLTF(selectedTrails);
			} else if (selectedTrails.type == "obj") {
				loadTrailsOBJ(selectedTrails);
			}
		}

		function loadTrailsGLTF(selectedTrails) {
			for (let i = 0; i < 9; i++) {
				new GLTFLoader()
					.load('./3d_models/trails/gltf/' + selectedTrails.id + '/object.glb', function (gltf) {
						const trail = gltf.scene;
						const num = ((1 - (i / 10)) % 1) / 10000
						trail.scale.set(num, num, num);
						scene.add(trail);
						trails.push(trail);
					}, undefined, function (error) {
						console.error(error);
					});
			}
		}

		function loadTrailsOBJ(selectedTrails) {
			for (let i = 0; i < 9; i++) {
				new MTLLoader()
					.setPath('./3d_models/trails/obj/' + selectedTrails.id + '/')
					.load('object.mtl', function (materials) {
						materials.preload();
						new OBJLoader()
							.setMaterials(materials)
							.setPath('./3d_models/trails/obj/' + selectedTrails.id + '/')
							.load('object.obj', function (object) {
								const trail = object;
								const num = ((1 - (i / 10)) % 1) / 10000
								trail.scale.set(num, num, num);
								scene.add(trail);
								trails.push(trail);
							}, undefined, function (error) {
								console.error(error);
							});
					});
			}
		}

		function changeAircraft(selectedAircraft) {
			AIRCRAFTS_META_DATA.forEach(option => { document.getElementById(option.id).classList.remove("selected") });
			document.getElementById(selectedAircraft.id).classList.add("selected");
			scene.remove(aircraft);
			loadAircraft(selectedAircraft);
		}

		function changeTrails(selectedTrails) {
			TRAILS_META_DATA.forEach(option => { document.getElementById(option.id).classList.remove("selected") });
			document.getElementById(selectedTrails.id).classList.add("selected");
			scene.remove(trails);
			trails.forEach(trail => {scene.remove(trail)});
			trails = [];
			loadTrails(selectedTrails);
		}

		function loadLight() {
			const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
			light.position.set(0, 1, 0);
			scene.add(light);

			const light2 = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 0.1);
			light2.position.set(30, 30, 30);
			scene.add(light2);
		}

		function onWindowResize() {
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();
			renderer.setSize(window.innerWidth, window.innerHeight);
		}

		function handleController(controller) {
			const userData = controller.userData;
			cursor.set(0, 0, - 0.2).applyMatrix4(controller.matrixWorld);
			if (userData.isSelecting === true) {
				if (userData.skipFrames >= 0) {
					// TODO(mrdoob) Revisit this

					userData.skipFrames--;
					painter.moveTo(cursor);
				} else {
					painter.lineTo(cursor);
					locations.push([cursor.x, cursor.y, cursor.z])
					painter.update();
				}
			}
		}

		function animate() {
			renderer.setAnimationLoop(render);
		}

		function render() {
			handleController(controller);
			if (aircraft)
				placeAircraft()
			renderer.render(scene, camera);
		}

		function placeAircraft() {
			if (locations.length === 0) {
				aircraft?.position.set(0, 0, 0)
				aircraft?.rotation.set(0, 0, 0)
				trails.forEach(trail => trail.position.set(NaN, 0, 0))
				trails.forEach(trail => trail.rotation.set(0, 0, 0))
			} else if (locations.length === 1)
				aircraft?.position.set(...locations[0])
			else {
				const smoothLocations = smooth(addMidpoints(locations, 8));
				const currentTravelPercent = getCurrentTravelPercent();
				//document.getElementById("button-reset").innerHTML = (currentTravelPercent*100).toFixed(2);
				const currLoc = currentLocationByPercent(smoothLocations, currentTravelPercent),
					nextLoc = currentLocationByPercent(smoothLocations, currentTravelPercent + 0.01);

				aircraft?.position.set(...currLoc);
				aircraft.lookAt(...nextLoc);

				for (let i = 0; i < trails.length; i++) {
					const currTrailLoc = currentLocationByPercent(smoothLocations, currentTravelPercent + 0.98 - (i / 50));
					trails[i].position.set(...currTrailLoc);
					trails[i].rotation.x += (0.05 + i / 75);
					trails[i].rotation.z += (0.05 + i / 75);
					trails[i].rotation.z += (0.05 + i / 75);
				}
			}
		}

		function smooth(locations) {
			let result = [locations[0]];
			for (let i = 1; i < locations.length - 1; i++) {
				result.push(
					[
						(locations[i - 1][0] + locations[i][0] + locations[i + 1][0]) / 3,
						(locations[i - 1][1] + locations[i][1] + locations[i + 1][1]) / 3,
						(locations[i - 1][2] + locations[i][2] + locations[i + 1][2]) / 3
					]
				);
			}
			result.push(locations[locations.length - 1])
			return result;
		}

		function addMidpoints(locations, iterations = 1) {
			let result = [locations[0]];
			for (let i = 1; i < locations.length; i++) {
				result.push(
					[
						(locations[i - 1][0] + locations[i][0]) / 2,
						(locations[i - 1][1] + locations[i][1]) / 2,
						(locations[i - 1][2] + locations[i][2]) / 2
					],
					locations[i]
				);
			}
			if (iterations > 1)
				return addMidpoints(locations, iterations - 1)
			return result;
		}

		function currentLocationByPercent(locations, percent) {
			if(percent >= 1) return currentLocationByPercent(locations, percent % 1)
			if(percent < 0) return currentLocationByPercent(locations, (percent + 100) % 1)

			const idx = Math.floor(locations.length * percent),
				  r = (locations.length * percent) % 1;

			if(idx === locations.length-1)
				return locations[idx];

			return locations[idx].map((val, axis) => val + (locations[idx+1][axis]-val) * r)
		}

		function getCurrentTravelPercent() {
			const totalMillis = travelLength(locations) * 10000;
			if (Date.now() - animationCycleStart > totalMillis)
				animationCycleStart = Date.now();

			return (Date.now() - animationCycleStart) / totalMillis;
		}

		function travelLength(locations) {
			let result = 0;
			for (let i = 0; i < locations.length; i++) {
				result += oclidianDistance(locations[i], locations[(i + 1) % locations.length])
			}
			return result;
		}

		function oclidianDistance([x0, y0, z0], [x1, y1, z1]) {
			return Math.sqrt(
				Math.pow(x1 - x0, 2) +
				Math.pow(y1 - y0, 2) +
				Math.pow(z1 - z0, 2)
			)
		}

		window.onerror = function myErrorHandler(errorMsg, url, lineNumber) {
			alert("Error occured: " + JSON.stringify({errorMsg, url, lineNumber}));//or any message
			alert("toError:", window.toError)
			return false;
		}

	</script>
</body>

</html>